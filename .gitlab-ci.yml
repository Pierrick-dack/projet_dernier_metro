# .gitlab-ci.yml - S09 COMPLET
stages:
  - test
  - build

# Test unitaires seulement (sans base de donnÃ©es)
test:
  stage: test
  image: node:18-alpine
  before_script:
    - cd api
    - npm install
  script:
    - echo "ğŸ§ª Running unit tests..."
    - npm test
  only:
    - main
    - merge_requests

# Build Docker avec Kaniko - OPTIMISÃ‰
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  before_script:
    - echo "ğŸ” Configuration vÃ©rification..."
    - echo "ğŸ“¦ Registry: ${CI_REGISTRY_IMAGE}"
    - echo "ğŸ·ï¸ Tags: latest, ${CI_COMMIT_SHORT_SHA}"
    - echo "ğŸ“ Working dir: $(pwd)"
    - echo "ğŸ³ Dockerfile content:"
    - cat api/Dockerfile || echo "âŒ Dockerfile not found"
  script:
    - echo "ğŸ”¨ Building and pushing Docker images..."
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "api/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:latest"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}"
      --cache=true
      --cache-ttl=24h
      --snapshotMode=redo
      --use-new-run
    - echo "âœ… Build successful! Images pushed to GitLab Registry"
    - echo "ğŸ“Š Images available at:"
    - echo "   - ${CI_REGISTRY_IMAGE}:latest"
    - echo "   - ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  after_script:
    - echo "ğŸ‰ S09 - Build & Push Docker en CI: COMPLETED"
    - echo "âœ… Two tags pushed: latest + commit SHA"
    - echo "âœ… GitLab Registry used"
    - echo "âœ… Docker cache enabled"
  only:
    - main