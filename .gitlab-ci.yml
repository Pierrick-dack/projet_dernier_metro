# .gitlab-ci.yml COMPLET
stages:
  - test

variables:
  DB_HOST: postgres
  DB_PORT: 5432
  DB_NAME: postgres
  DB_USER: postgres
  DB_PASSWORD: postgres

test:
  stage: test
  image: node:18-alpine
  services:
    - postgres:13-alpine
  before_script:
    - cd api
    - npm install
    # Installation de PostgreSQL client et attente que la DB soit prÃªte
    - apk add --no-cache postgresql-client
    - until pg_isready -h postgres -p 5432; do sleep 1; done
  script:
    - npm test
  only:
    - main
    - merge_requests